#!/bin/sh
#
# This script generates a shell script that will perform a run and
# diff for SPEC2000/2004 programs.
#
# It inherits the necessary state for the run from the environment.
# Specifically:
# 
#   SPECIN:      input selector (test, train, ref)
#   UNITSRCPATH: unit src path
#   SIMULATOR:   wrapper to use for siminvocation
# 
#----------------------------
#
error() {
  typeset msg="$*"
  echo "$ME: error: $msg" 1>&2
  echo "# $ME: error: $msg" 
  echo "exit 1"
  exit 1
}
# 
checkinout() {
  typeset flav=$1
  typeset f=""
  LEGAL="test train ref"
  for f in $LEGAL
  do
    if (test "$flav" = "$f") then
      return
    fi
  done
  error "bad input/output set: \"$flav\""
  exit 1
}
#
set_executable() {
  typeset unit=`basename $1`
  executable=`echo $unit | sed 's/.*\.//' | sed 's/_m$//' | sed 's/_s$//'`
  case "$unit" in
      ex1 ) executable=ex1 ;;
#     ex2 ) executable="ex2.1 ex2.2 ";;
      
  esac

}
#
set_group() {
  typeset unit=$1
  typeset gg=`dirname $unit`
  typeset g=`basename $gg`
  group=$g
  case "$g" in
      SPECint2000) group=CINT99 ;;
      SPECint99_rejects) group=CINT99_rejects ;;
      SPECfp2000) group=CFP99 ;;
      SPECint2006) group=CINT06 ;;
      SPECfp2006) group=CFP06 ;;
      SPEC2006_rejects) group=C06_rejects ;;
  esac
}
#
set_unit_name() {
  unit=`basename $1`
}
#
#----------------------------
#
# Grab input, output, and unit, checking along the way
#
ME=$0
checkinout "$SPECIN"
if (test "$UNITSRCPATH" = "") then
  error "Bad setting for UNITSRCPATH env var"
fi
# strip off Src subdir
UNITSRCPATH=`dirname $UNITSRCPATH`
#
# Derive unit name, group, executable
#
set_group $UNITSRCPATH
set_unit_name $UNITSRCPATH
set_executable $UNITSRCPATH
#
# Select scripts to run 
#
run_script="$UNITSRCPATH/Src/bin/run_utils/run_${group}_${SPECIN}"
diff_script="$UNITSRCPATH/Src/bin/run_utils/diff_${group}_${SPECIN}"
#
# Check for existence of scripts
#
if (test ! -x $run_script) then
  error "can't find run script $run_script"
fi
if (test ! -x $diff_script) then
  error "can't find diff script $diff_script"
fi

unit_src_dir=${UNITSRCPATH}

#
# Emit script
# 
cat <<EOF1
#!/bin/sh
#
# This script generated by $ME
#
/bin/rm -rf run
/bin/mkdir run
if (test -d data/all/input) then
   /bin/cp -r data/all/input/* run
fi
if (test -d data/$SPECIN/input) then
  /bin/cp -r data/$SPECIN/input/* run
fi
/bin/cp $executable run
(cd run && $run_script $unit "\$SIMULATOR")
rdir="\$PWD/run"
exec $diff_script $unit \$rdir $unit_src_dir
EOF1




